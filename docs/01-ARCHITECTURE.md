# 系统架构文档 (System Architecture)

## 1. 概述 (Overview)

### 1.1 系统定位
彩票分析助手是一个基于 Claude Code 的 AI 驱动数据分析工具，提供中国福利彩票双色球（SSQ）和体育彩票大乐透（DLT）的历史数据分析服务。

### 1.2 设计理念

```
┌─────────────────────────────────────────────────────────────────┐
│                      设计哲学                                    │
├─────────────────────────────────────────────────────────────────┤
│  • 安全第一：始终强调随机性，明确告知风险                        │
│  • 数据驱动：基于统计学的分析方法，避免主观猜测                  │
│  • 易于扩展：模块化架构，便于添加新功能和新彩种                  │
│  • 用户友好：清晰的界面和文档，降低使用门槛                      │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 系统架构图 (System Architecture Diagram)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           用户层 (User Layer)                                │
│  ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐      │
│  │   交互式分析     │    │   报告生成       │    │   固定号码分析   │      │
│  │   对话界面       │    │   HTML 报告      │    │   胆码选择       │      │
│  └──────────────────┘    └──────────────────┘    └──────────────────┘      │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        AI 处理层 (AI Layer)                                  │
│  ┌──────────────────────────────────────────────────────────────────┐       │
│  │                    Claude Code 核心引擎                           │       │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐   │       │
│  │  │ 彩票数据获取 │  │ 彩票统计分析 │  │ 号码预测与生成       │   │       │
│  │  │ Skill        │  │ Skill        │  │ Skill                │   │       │
│  │  └──────────────┘  └──────────────┘  └──────────────────────┘   │       │
│  └──────────────────────────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      脚本执行层 (Script Layer)                               │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐          │
│  │ fetch_lottery_   │  │ analyze_history  │  │ generate_fixed_  │          │
│  │ data.py          │  │ .py              │  │ numbers.py       │          │
│  │ 数据获取脚本     │  │ 历史分析脚本     │  │ 固定号码分析脚本 │          │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘          │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      数据层 (Data Layer)                                     │
│  ┌──────────────────────────────────────────────────────────────────┐       │
│  │                         数据存储结构                              │       │
│  │  data/                                                           │       │
│  │  ├── ssq/                                                        │       │
│  │  │   └── history.json      # 双色球历史开奖数据                  │       │
│  │  └── dlt/                                                        │       │
│  │      └── history.json      # 大乐透历史开奖数据                  │       │
│  └──────────────────────────────────────────────────────────────────┘       │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────┐       │
│  │                         配置文件                                  │       │
│  │  .claude/config/lottery_config.json                              │       │
│  └──────────────────────────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 3. 核心组件详解 (Core Components)

### 3.1 Skill 系统

Skill 系统是 Claude Code 的插件机制，用于扩展 AI 的能力：

#### 3.1.1 Data Fetcher Skill
```
职责：彩票数据获取与管理
功能：
  • 从公开 API 获取开奖数据
  • 数据格式验证
  • 本地存储管理
  • 增量更新机制

调用方式：
  @lottery_data_fetcher --action fetch --type ssq
  @lottery_data_fetcher --action list --type dlt
```

#### 3.1.2 Analyzer Skill
```
职责：历史数据统计分析
功能：
  • 热号/冷号分析
  • 遗漏值统计
  • 奇偶比/大小比分析
  • 连号分析
  • 区间分布分析
  • 和值与跨度分析

调用方式：
  @lottery_analyzer --type ssq --periods 100 --method hot_cold
```

#### 3.1.3 Predictor Skill
```
职责：号码预测与生成
功能：
  • 基于统计的号码推荐
  • 固定号码组合生成
  • 智能选号策略
  • 风险评级

调用方式：
  @lottery_predictor --type dlt --fixed-red 05,12,23
```

### 3.2 脚本系统 (Script System)

#### 3.2.1 数据获取脚本
**文件**: `scripts/fetch_lottery_data.py`

```python
类结构：
  LotteryDataFetcher
  ├── fetch_data(type, limit)     # 主数据获取方法
  ├── validate_data(data, type)   # 数据验证
  ├── save_data(data, path)       # 数据保存
  └── get_last_n_draws(n)         # 获取最近 N 期

关键函数：
  - fetch_cwl_data(): 从中国福彩中心获取数据
  - fetch_lottery_post_data(): 从彩票网获取数据
  - parse_ssq_record(): 解析双色球记录
  - parse_dlt_record(): 解析大乐透记录
```

#### 3.2.2 历史分析脚本
**文件**: `scripts/analyze_history.py`

```python
类结构：
  LotteryAnalyzer
  ├── analyze_hot_cold()          # 热冷号分析
  ├── analyze_missing()           # 遗漏值分析
  ├── analyze_odd_even()          # 奇偶比分析
  ├── analyze_big_small()         # 大小比分析
  ├── analyze_consecutive()       # 连号分析
  ├── analyze_zones()             # 区间分布分析
  ├── analyze_sum()               # 和值分析
  └── analyze_span()              # 跨度分析

分析方法说明：
  1. 热号/冷号：统计各号码出现频率，识别高频/低频号码
  2. 遗漏值：计算各号码自上次出现后未出现的期数
  3. 奇偶比：红球奇偶数量比例分布
  4. 大小比：红球大小数量比例（1-16小，17-33大）
  5. 连号：相邻开奖号码的出现规律
  6. 区间分布：三个区间（1-11, 12-22, 23-33）的分布
  7. 和值：红球号码总和的统计特征
  8. 跨度：最大号与最小号的差值
```

#### 3.2.3 固定号码脚本
**文件**: `scripts/generate_fixed_numbers.py`

```python
类结构：
  FixedNumberAnalyzer
  ├── analyze_fixed_numbers()     # 分析固定号码组合
  ├── generate_combinations()     # 生成候选组合
  └── validate_combination()      # 验证组合有效性

功能说明：
  • 支持指定红球胆码和蓝球胆码
  • 自动计算剩余号码的合理范围
  • 基于历史规律生成候选组合
  • 提供组合质量评估
```

### 3.3 数据格式规范

#### 3.3.1 双色球 (SSQ) 数据结构
```json
{
  "issue": "2024001",
  "date": "2024-01-02",
  "red_balls": ["03", "08", "12", "19", "23", "29"],
  "blue_ball": "14",
  "prize_pool": "2,500,000,000",
  "first_prize_count": 5,
  "first_prize_amount": "10,000,000"
}
```

#### 3.3.2 大乐透 (DLT) 数据结构
```json
{
  "issue": "2024001",
  "date": "2024-01-01",
  "front_zones": ["05", "12", "18", "25", "33"],
  "back_zones": ["03", "09"],
  "prize_pool": "1,800,000,000",
  "first_prize_count": 3,
  "first_prize_amount": "10,000,000"
}
```

## 4. 执行流程 (Execution Flows)

### 4.1 数据获取流程

```
用户指令
    │
    ▼
┌───────────────────┐
│  Data Fetcher     │
│  Skill 接收指令   │
└───────────────────┘
    │
    ▼
┌───────────────────┐     ┌─────────────────┐
│  fetch_lottery_   │────▶│  API 数据源     │
│  data.py 执行     │     │  (中国福彩等)   │
└───────────────────┘     └─────────────────┘
    │                              │
    ▼                              ▼
┌───────────────────┐     ┌─────────────────┐
│  数据验证与清洗   │◀────│  原始数据       │
└───────────────────┘     └─────────────────┘
    │
    ▼
┌───────────────────┐
│  保存至本地 JSON  │
│  data/ssq/*.json  │
└───────────────────┘
```

### 4.2 分析流程

```
用户请求分析
    │
    ▼
┌───────────────────┐
│ Analyzer Skill    │
│ 解析分析需求      │
└───────────────────┘
    │
    ▼
┌───────────────────┐
│ analyze_history   │
│ .py 加载数据      │
└───────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│ 执行分析算法                    │
│ ┌─────┐ ┌─────┐ ┌─────┐        │
│ │热冷号│ │遗漏值│ │奇偶比│  ...  │
│ └─────┘ └─────┘ └─────┘        │
└─────────────────────────────────┘
    │
    ▼
┌───────────────────┐
│ 生成分析报告      │
│ (文本/JSON/HTML)  │
└───────────────────┘
```

### 4.3 预测流程

```
用户指定胆码
    │
    ▼
┌───────────────────┐
│ Predictor Skill   │
│ 计算预测参数      │
└───────────────────┘
    │
    ▼
┌───────────────────┐
│ generate_fixed_   │
│ numbers.py 执行   │
└───────────────────┘
    │
    ▼
┌───────────────────┐
│ 基于历史规律      │
│ 生成候选组合      │
└───────────────────┘
    │
    ▼
┌───────────────────┐
│ 风险评级与        │
│ 免责声明          │
└───────────────────┘
```

## 5. 扩展性设计 (Extensibility)

### 5.1 添加新彩种

要添加新的彩票类型，需要：

1. **更新配置** (`lottery_config.json`):
```json
{
  "lottery_types": {
    "new_lottery": {
      "name": "新彩种名称",
      "red_range": [1, 35],
      "blue_range": [1, 12],
      "red_count": 5,
      "blue_count": 2
    }
  }
}
```

2. **添加数据解析器**:
   - 在 `fetch_lottery_data.py` 中添加 `parse_new_lottery_record()`

3. **添加分析方法**:
   - 在 `analyze_history.py` 中扩展分析逻辑（如果需要特殊分析）

4. **更新 Skills**:
   - 在 Skill 文件中添加对新彩种的支持

### 5.2 添加新分析方法

要添加新的分析维度，需要：

1. **在 `LotteryAnalyzer` 类中添加新方法**:
```python
def analyze_new_method(self, history_data, **kwargs):
    """新分析方法"""
    result = {}
    # 分析逻辑
    return result
```

2. **更新 Skill 调用接口**:
   - 在 `skill_lottery_analyzer.md` 中添加新方法说明

3. **更新文档**:
   - 在 `docs/03-ANALYSIS_METHODS.md` 中记录新方法

## 6. 安全设计 (Security Design)

### 6.1 数据安全
- 所有数据来自公开数据源
- 不存储用户个人信息
- 本地数据文件仅用于缓存

### 6.2 风险管控
```
┌──────────────────────────────────────────────────┐
│  风险管控机制                                    │
├──────────────────────────────────────────────────┤
│  ✓ 所有预测结果必须附带免责声明                  │
│  ✓ 强调彩票的随机性和不可预测性                  │
│  ✓ 提供理性购彩建议                              │
│  ✓ 禁止未成年人购彩提示                          │
│  ✓ 单次投注金额上限建议                          │
└──────────────────────────────────────────────────┘
```

### 6.3 合规性
- 遵循中国彩票管理规定
- 仅作为娱乐工具，不提供赌博服务
- 明确标识 "仅供娱乐参考"

## 7. 性能优化 (Performance Optimization)

### 7.1 数据处理优化
- 使用生成器处理大数据集
- 缓存频繁访问的数据
- 增量更新替代全量更新

### 7.2 分析算法优化
- 使用 NumPy/Pandas 进行向量化计算
- 预计算常用统计指标
- 异步处理耗时操作

### 7.3 缓存策略
```
┌──────────────────────────────────────────────────┐
│  缓存层级                                        │
├──────────────────────────────────────────────────┤
│  L1: AI 上下文缓存 (Claude Code 内部)           │
│  L2: 本地 JSON 数据文件                          │
│  L3: 分析结果缓存 (未来可考虑)                  │
└──────────────────────────────────────────────────┘
```

## 8. 错误处理 (Error Handling)

### 8.1 错误分类

| 错误类型 | 示例 | 处理方式 |
|---------|------|---------|
| 数据错误 | API 返回格式异常 | 降级到本地缓存数据 |
| 网络错误 | 数据源不可达 | 重试机制 + 错误提示 |
| 参数错误 | 无效彩种类型 | 参数验证 + 友好提示 |
| 分析错误 | 数据量不足 | 返回可用结果 + 警告 |

### 8.2 错误处理流程
```
检测错误
    │
    ├──▶ 可恢复错误 ────▶ 自动恢复 ────▶ 继续执行
    │
    └──▶ 不可恢复错误 ──▶ 记录日志 ───▶ 用户提示
                              │
                              ▼
                         提供解决方案
```

## 9. 部署架构 (Deployment Architecture)

### 9.1 开发环境
```
开发者机器
    ├── VS Code + Claude Code 扩展
    ├── Python 3.8+
    ├── Git 版本控制
    └── 本地数据目录
```

### 9.2 使用模式
```
┌──────────────────────────────────────────────────┐
│  使用模式                                        │
├──────────────────────────────────────────────────┤
│  1. 交互式对话 (推荐)                            │
│     用户 ↔ Claude Code ↔ 脚本执行              │
│                                                  │
│  2. 命令行脚本                                   │
│     直接运行 Python 脚本                         │
│                                                  │
│  3. HTML 报告生成                                │
│     生成可视化分析报告                           │
└──────────────────────────────────────────────────┘
```

## 10. 版本演进 (Version Evolution)

### 10.1 当前版本: v1.0.0
- ✅ 基础数据获取
- ✅ 8 种统计分析方法
- ✅ 固定号码分析
- ✅ 交互式 AI 对话
- ✅ HTML 报告模板

### 10.2 未来规划
- 🔮 机器学习预测模型
- 🔮 实时数据 API
- 🔮 可视化图表增强
- 🔮 移动端适配
- 🔮 多语言支持

---

**文档版本**: 1.0.0  
**最后更新**: 2026-02-07  
**维护者**: Lottery Analysis Agent Team
